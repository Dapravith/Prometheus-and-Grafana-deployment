name: Observability Stack CI/CD

permissions:
  contents: read
  security-events: write

on:
  push:
    branches:
      - main
      - "feature/**"
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  KUBECONFIG: ${{ github.workspace }}/kubeconfig

jobs:
  validate-configurations:
    name: Validate Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install pyyaml

      - name: Validate Kubernetes YAML
        run: |
          echo "Validating Kubernetes manifests..."
          for file in $(find kubernetes -name "*.yml" -o -name "*.yaml"); do
            python3 -c "import yaml; yaml.safe_load_all(open('$file'))"
          done

      - name: Validate Ansible YAML
        run: |
          echo "Validating Ansible playbooks..."
          for file in $(find ansible -name "*.yml"); do
            python3 -c "import yaml; yaml.safe_load(open('$file'))"
          done

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform fmt check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform validate
        run: |
          cd terraform
          terraform validate

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Trivy (IaC scan)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: config
          scan-ref: .
          format: sarif
          output: trivy-results.sarif

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-results.sarif

      - name: TruffleHog secret scan (push)
        uses: trufflesecurity/trufflehog@main
        if: github.event_name != 'pull_request'
        with:
          path: ./

      - name: TruffleHog secret scan (PR)
        uses: trufflesecurity/trufflehog@main
        if: github.event_name == 'pull_request'
        with:
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: v1.28.0

      - name: Install kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin

      - name: Lint Kubernetes manifests
        run: |
          for file in $(find kubernetes -name "*.yaml"); do
            kubeval --strict "$file" || true
          done

      - name: Shellcheck scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck quickstart.sh || true

  deploy-to-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [validate-configurations, security-scan, lint-and-test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create kind cluster
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: observability-test

      - name: Deploy observability stack
        run: |
          kubectl apply -f kubernetes/namespaces/
          kubectl apply -f kubernetes/prometheus/
          kubectl apply -f kubernetes/grafana/
          kubectl apply -f kubernetes/loki/
          kubectl apply -f kubernetes/mimir/
          kubectl apply -f kubernetes/alloy/
          kubectl apply -f kubernetes/opentelemetry/

      - name: Wait for pods
        run: |
          kubectl wait --for=condition=ready pod -n observability --all --timeout=300s || true

      - name: Deployment status
        run: kubectl get all -n observability

  monitoring-validation:
    name: Validate Monitoring Stack
    runs-on: ubuntu-latest
    needs: deploy-to-test
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Prometheus to be ready
        run: |
          kubectl wait --namespace=observability \
              --for=condition=ready pod \
              --selector=app=prometheus \
              --timeout=300s

      - name: Test Prometheus
        run: |
          kubectl port-forward -n observability svc/prometheus-service 9090:9090 &
          sleep 10
          curl -f http://localhost:9090/-/healthy

      - name: Test Grafana
        run: |
          kubectl port-forward -n observability svc/grafana-service 3000:3000 &
          sleep 10
          curl -f http://localhost:3000/api/health

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs:
      - validate-configurations
      - security-scan
      - lint-and-test
      - deploy-to-test
      - monitoring-validation
    if: always()
    steps:
      - name: Workflow result
        run: |
          echo "Workflow status: ${{ job.status }}"
