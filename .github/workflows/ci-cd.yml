name: Observability Stack CI/CD

permissions:
  contents: read
  security-events: write

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main
  workflow_dispatch:

env:
  KUBECONFIG: ${{ github.workspace }}/kubeconfig

jobs:
  validate-configurations:
    name: Validate Configurations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pyyaml

      - name: Validate YAML syntax
        run: |
          echo "Validating Kubernetes manifests..."
          for file in $(find kubernetes -name "*.yaml" -o -name "*.yml"); do
            echo "Checking $file"
            python3 -c "import yaml; yaml.safe_load_all(open('$file'))"
          done
          echo "✓ All Kubernetes YAML files are valid"

      - name: Validate Ansible playbooks
        run: |
          echo "Validating Ansible playbooks..."
          for file in $(find ansible -name "*.yml"); do
            echo "Checking $file"
            python3 -c "import yaml; yaml.safe_load(open('$file'))"
          done
          echo "✓ All Ansible YAML files are valid"

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform Format Check
        run: |
          cd terraform
          terraform fmt -check -recursive

      - name: Terraform Init
        run: |
          cd terraform
          terraform init -backend=false

      - name: Terraform Validate
        run: |
          cd terraform
          terraform validate

  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets in code
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Lint Kubernetes manifests with kubeval
        run: |
          wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
          tar xf kubeval-linux-amd64.tar.gz
          sudo mv kubeval /usr/local/bin
          
          echo "Linting Kubernetes manifests..."
          for file in $(find kubernetes -name "*.yaml"); do
            echo "Linting $file"
            kubeval --strict "$file" || true
          done

      - name: Run shellcheck on scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck quickstart.sh || true

  deploy-to-test:
    name: Deploy to Test Environment
    runs-on: ubuntu-latest
    needs: [validate-configurations, security-scan, lint-and-test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: observability-test
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
            - role: worker
            - role: worker

      - name: Deploy observability stack
        run: |
          echo "Deploying to test cluster..."
          kubectl cluster-info
          
          # Deploy namespace
          kubectl apply -f kubernetes/namespaces/
          
          # Deploy Prometheus
          kubectl apply -f kubernetes/prometheus/
          
          # Deploy Grafana
          kubectl apply -f kubernetes/grafana/
          
          # Deploy Loki
          kubectl apply -f kubernetes/loki/
          
          # Deploy Mimir
          kubectl apply -f kubernetes/mimir/
          
          # Deploy Alloy
          kubectl apply -f kubernetes/alloy/
          
          # Deploy OpenTelemetry
          kubectl apply -f kubernetes/opentelemetry/
          
          echo "Deployment completed"

      - name: Wait for pods to be ready
        run: |
          echo "Waiting for pods to be ready..."
          kubectl wait --for=condition=ready pod -l app=prometheus -n observability --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=grafana -n observability --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=loki -n observability --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=mimir -n observability --timeout=300s || true
          kubectl wait --for=condition=ready pod -l app=otel-collector -n observability --timeout=300s || true

      - name: Check deployment status
        run: |
          echo "=== Deployment Status ==="
          kubectl get all -n observability
          
          echo "=== Pod Details ==="
          kubectl describe pods -n observability

      - name: Run health checks
        run: |
          echo "Running health checks..."
          
          # Check Prometheus
          kubectl port-forward -n observability svc/prometheus-service 9090:9090 &
          sleep 5
          curl -f http://localhost:9090/-/healthy || echo "Prometheus health check failed"
          
          # Check Grafana
          kubectl port-forward -n observability svc/grafana-service 3000:3000 &
          sleep 5
          curl -f http://localhost:3000/api/health || echo "Grafana health check failed"
          
          # Check Loki
          kubectl port-forward -n observability svc/loki-service 3100:3100 &
          sleep 5
          curl -f http://localhost:3100/ready || echo "Loki health check failed"

      - name: Export logs on failure
        if: failure()
        run: |
          echo "=== Exporting logs ==="
          mkdir -p logs
          for pod in $(kubectl get pods -n observability -o name); do
            kubectl logs -n observability $pod > logs/$(echo $pod | tr '/' '-').log || true
          done

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-logs
          path: logs/

  monitoring-validation:
    name: Validate Monitoring Stack
    runs-on: ubuntu-latest
    needs: [deploy-to-test]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kind
        uses: helm/kind-action@v1.8.0
        with:
          cluster_name: observability-test

      - name: Test Prometheus metrics scraping
        run: |
          echo "Testing Prometheus metrics..."
          kubectl port-forward -n observability svc/prometheus-service 9090:9090 &
          sleep 10
          
          # Check if Prometheus is scraping targets
          curl -s http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | {job: .labels.job, health: .health}'

      - name: Test Grafana datasources
        run: |
          echo "Testing Grafana datasources..."
          kubectl port-forward -n observability svc/grafana-service 3000:3000 &
          sleep 10
          
          # Check datasources
          curl -s -u admin:admin http://localhost:3000/api/datasources | jq '.[].name'

      - name: Test Loki log ingestion
        run: |
          echo "Testing Loki..."
          kubectl port-forward -n observability svc/loki-service 3100:3100 &
          sleep 10
          
          # Check Loki is ready
          curl -f http://localhost:3100/ready

      - name: Generate monitoring report
        run: |
          echo "=== Monitoring Stack Health Report ===" > monitoring-report.txt
          echo "Generated at: $(date)" >> monitoring-report.txt
          echo "" >> monitoring-report.txt
          
          echo "Pod Status:" >> monitoring-report.txt
          kubectl get pods -n observability >> monitoring-report.txt
          echo "" >> monitoring-report.txt
          
          echo "Service Status:" >> monitoring-report.txt
          kubectl get svc -n observability >> monitoring-report.txt
          echo "" >> monitoring-report.txt

      - name: Upload monitoring report
        uses: actions/upload-artifact@v3
        with:
          name: monitoring-report
          path: monitoring-report.txt

  notify:
    name: Notify Status
    runs-on: ubuntu-latest
    needs: [validate-configurations, security-scan, lint-and-test, deploy-to-test, monitoring-validation]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          echo "Workflow completed with status: ${{ job.status }}"
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ All checks passed!"
          else
            echo "✗ Some checks failed. Please review the logs."
          fi
