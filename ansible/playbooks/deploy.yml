---
- name: Deploy Observability Stack
  hosts: localhost
  gather_facts: false
  vars:
    kubernetes_manifests_dir: "../kubernetes"
    namespace: "observability"
  
  tasks:
    - name: Check if kubectl is available
      command: kubectl version --client
      register: kubectl_check
      changed_when: false
      failed_when: false

    - name: Fail if kubectl is not available
      fail:
        msg: "kubectl is not available. Please install kubectl."
      when: kubectl_check.rc != 0

    - name: Create namespace
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Namespace
          metadata:
            name: "{{ namespace }}"
            labels:
              name: "{{ namespace }}"
              environment: production

    - name: Deploy Prometheus
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/prometheus/{{ item }}"
      loop:
        - configmap.yaml
        - deployment.yaml

    - name: Wait for Prometheus to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: prometheus
      register: prometheus_deployment
      until: prometheus_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Grafana
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/grafana/deployment.yaml"

    - name: Wait for Grafana to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: grafana
      register: grafana_deployment
      until: grafana_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Loki
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/loki/deployment.yaml"

    - name: Wait for Loki to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: loki
      register: loki_deployment
      until: loki_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Mimir
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/mimir/deployment.yaml"

    - name: Wait for Mimir to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: mimir
      register: mimir_deployment
      until: mimir_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Grafana Alloy
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/alloy/deployment.yaml"

    - name: Wait for Alloy to be ready
      kubernetes.core.k8s_info:
        kind: DaemonSet
        namespace: "{{ namespace }}"
        name: alloy
      register: alloy_daemonset
      until: alloy_daemonset.resources[0].status.numberReady | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy OpenTelemetry Collector
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/opentelemetry/deployment.yaml"

    - name: Wait for OpenTelemetry Collector to be ready
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
        name: otel-collector
      register: otel_deployment
      until: otel_deployment.resources[0].status.readyReplicas | default(0) >= 1
      retries: 30
      delay: 10

    - name: Deploy Ingress
      kubernetes.core.k8s:
        state: present
        namespace: "{{ namespace }}"
        src: "{{ kubernetes_manifests_dir }}/ingress/ingress.yaml"

    - name: Get deployment status
      kubernetes.core.k8s_info:
        kind: Deployment
        namespace: "{{ namespace }}"
      register: deployments

    - name: Display deployment status
      debug:
        msg: "{{ item.metadata.name }}: {{ item.status.readyReplicas | default(0) }}/{{ item.spec.replicas }} replicas ready"
      loop: "{{ deployments.resources }}"
      loop_control:
        label: "{{ item.metadata.name }}"
